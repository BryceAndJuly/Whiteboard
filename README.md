## 更新记录

### V1.0.0

* 首次提交

### V1.0.1

* 修复问题：[将白板以嵌入块形式嵌入到其他文档时显示不完全](https://github.com/BryceAndJuly/Whiteboard/issues/1)

### V1.0.2

* **修复问题：禁用白板默认的自动聚焦功能；**

白板默认的自动聚焦行为会导致页面中出现抢焦点的问题。具体表现为：

* 在搜索界面，当结果预览界面出现白板时，焦点会转移到画板，导致搜索输入框失去焦点。如果需要继续输入关键词，你需要重新点一下输入框后才能继续输入，这点非常烦人。禁用后则无此问题。
* 在含有白板所在文档的嵌入块的页面中，白板的自动聚焦会跟笔记软件本身的【滚动到上次浏览位置】冲突，导致页面不能滚动到上次浏览的位置。

### V1.0.3

* 默认开启自动保存功能，编辑结束1.5s后自动保存数据。
> 如果觉得弹窗太分散注意力，可以点击空白处后，使用快捷键Alt+S开启/关闭【自动保存功能】，左上角会有消息提示。
> 一般会在初始化时，增、删或移动元素时触发自动保存。

### V1.0.4

* 减少自动保存时弹窗的干扰。

> 触发自动保存时不弹出【已保存】的消息提醒；
>
> 手动点击保存按钮、键盘上按Ctrl+S依旧保留弹窗提醒。

### V1.0.5
1、去掉刚打开白板时触发的那次自动保存，减少不必要的性能消耗，这样打开白板时更流畅些。
2、处理问题：在macOS端保存按钮失效的问题。

> * 关于在macOS端保存按钮的问题，我尝试处理了兼容，但是不知道有没有实际生效。使用该设备的用户如果发现还是没有生效，可以到仓库提Issue，我会重新处理。
> * 另外建议：最好在新建的空白页面嵌入该挂件，不要在有其他内容的文档里嵌入。简介里也说了嘛，会自动铺满，有其他内容的话会被遮挡的。


对于版本：V1.0.5

如果你**不想默认开启自动保存功能**，可以使用VS Code之类的编辑器打开挂件文件夹`Whiteboard`——`index.html`，

搜索：

```js
window._autoSave=!0
```

替换成：

```js
window._autoSave=0
```


如果你想**调整自动保存的延时时间**（默认是1500ms），可以打开挂件文件夹`Whiteboard`——`static`——`js`——`main.57b55d4d.js`

搜索：

```js
window._isDarwin?document.dispatchEvent(new KeyboardEvent("keydown",{key:"S",metaKey:!0,bubbles:!1})):document.dispatchEvent(new KeyboardEvent("keydown",{key:"S",ctrlKey:!0,bubbles:!1}))}),1500)
```

将最后那个数值：1500 改成你想设置的数值即可，单位是毫秒。




---







## 一、简介

一个基于[Excalidraw](https://github.com/excalidraw/excalidraw)的挂件，嵌入后会自动铺满文档，将一个文档当成一个白板。融合了块悬浮预览、关键词搜索定位、画板内不同元素之间的跳转等小功能。

可通过引用文档的方式来引用白板。如果需要将画好的白板导出并分享给别人，可以使用白板所在文档的导出/导入`SiYuan .sy.zip`​文件的功能。每个白板绑定一个存储在`assets/ExcalidrawFiles/`中的文件，文档删除后白板绑定的文件也会作为【未引用的资源】来方便手动删除。


## 二、使用前的设置

### 1、添加CSS代码片段

白板创建时，会自动设置所在文档的属性——`别名`​​的值为：`whiteboard`​​，这是为了解决打开白板所在文档时页面闪现出文档标题的问题。相应的，你需要在笔记软件的`设置`​​——`外观`​​中添加对应的CSS代码片段：

```css
/* 白板挂件——隐藏当前文档的标题、面包屑 */
.protyle-title.protyle-wysiwyg--attr:has(+ .protyle-wysiwyg.protyle-wysiwyg--attr[alias="whiteboard"]){
 visibility: hidden;
}

.protyle-breadcrumb:has(+ .protyle-content.protyle-content--transition > .protyle-wysiwyg.protyle-wysiwyg--attr[alias="whiteboard"]) {
   visibility: hidden;
}
```

为了美观，还需要隐藏掉挂件默认的边框：

```css
/* 挂件——去掉边框 */
.b3-typography iframe, .protyle-wysiwyg iframe {
    border: none;   
}
```

还有一个可选的样式，是设置悬浮窗大小的，个人感觉默认的窗口有点过于宽了才设置的，这个不重要，你可以根据自己的需要来决定是否添加。

```css
/* 悬浮窗口 */
.block__popover {
    z-index: 200 !important;
    width: 735px;
    border: 1px solid #94949482;
    min-height: 70vh;
    max-height: 75vh !important;
}
```

### 2、安装插件【开放 API】

* 安装这个插件是为了能在白板中悬浮预览笔记内块/文档的内容。
* 在`设置`​​​——`集市`​​​——​`插件`​​​页面，下载并启用插件`开放 API`​​​即可。

‍
## 三、开始使用

### 1、插入白板

下载完挂件后，在新建的空白文档中输入`/g`​​​并回车，在挂件列表选择`Whiteboard`​​​即可在当前文档中插入白板，默认铺满文档。

### 2、数据的保存

单击左上角的`保存`​​​按钮或者使用快捷键`Ctrl`​​​+`S`​​​来保存白板的数据。左上角会弹出提示：`已保存`​​​​​​​

白板的数据保存在：`assets/ExcalidrawFiles/ `​​​​​文件夹中，文件路径类似于：

```css
assets/ExcalidrawFiles/20231227015401-w0olmpi.excalidraw
```

使用白板挂件块的ID作为文件名。

**编辑完后记得点击保存、记得点击保存、记得点击保存，不然什么都没了。** 我自己比较勤按Ctrl+S，所以目前还没丢过内容。

### 3、块超链接的悬浮预览

* 在白板中插入链接的方式没有变化：先复制一个链接地址（外部链接或者某个块/文档的`块超链接`​​​​​），在画板中点击选中一个元素后按`Ctrl`​​​​​+`K`​​​​​后弹出链接输入框，粘贴链接并回车即可。
* 值得注意的是，如果插入的是块超链接，并且想在白板中悬浮预览该块的内容，你需要先打开预览开关。先单击白板空白处，然后按快捷键`Alt`​​​​​+`Q`​​是开启预览，按快捷键`Alt`​​​​​+`W`​​​​​是关闭预览。默认是关闭的，在开启状态下，鼠标悬浮在白板中某个元素的链接图标上时，能弹出悬浮窗来预览该块的内容，弹出窗口后可通过按`ESC`​​​​​键或者鼠标点击右上角`X`​​​​​来关闭窗口。

### 4、关键字的搜索、定位

* 可通过搜索框来搜索、定位白板内的文字，支持多个关键字（以空格隔开）。想要定位准的话需要画板重置缩放比例为：100%，在左下角设置。
* 搜索前建议先确认内容已经保存，因为搜索的内容是从保存的白板文件中读取的，如果你新增了内容且没保存，那么搜索到的结果可能是不全的。
* 先单击白板空白处获得焦点，然后按快捷键​`Alt`​​+`T`​​​​就可以唤出/关闭搜索框。唤出后点击白板空白处也可以关闭搜索框。
* 唤出的搜索框自动获取焦点，此时可以直接输入要查询的关键字，关键字之间以空格隔开，匹配到的结果会在约0.5s后显示在下方列表中。
* 弹出匹配的结果后，搜索框仍获得焦点，此时通过键盘的上、下方向键可以切换并定位匹配结果的位置。当然， 你还可以直接鼠标单击某个匹配的结果来定位它的位置。

### 5、白板内元素之间的跳转

* 比如：画板内要从元素A跳转到元素B。（此时画板缩放比例为：100%）
* 先选中元素B，按​`Ctrl`​​​​+​`C`​​​​来复制该元素，然后单击选中元素A，按住​`Ctrl`​​​​后，依次按​`J`​​​​、​`K`​​​​、​`V`​​​​后回车，即可生成链接。

  * 这个过程中，​`Ctrl`​​​​+​`J`​​​​是从刚刚复制的元素中获取元素ID，生成类似：`excalidraw://nFrmqWgyT-lXdsS15Yswu`​​​​这样的链接并复制到剪切板，此时左上角会提示：已将链接复制到剪切板。
  * 后面的​`Ctrl`​​​​+​`K`​​​​弹出链接输入框，​`Ctrl`​​​​+`V`​​​​粘贴就是常规的插入链接的方式了。
* 单击元素A上的链接图标，即可跳转到元素B的位置。（只适用于画板内，在画板外使用该链接并不能跳转）

### 6、清除文字之间的空格（不常用）

* 白板本身有个【将文本绑定到容器】的功能，我往里面粘贴文本的时候发现文字间的一些空格会让文字的换行变得不合理，看起来不舒服，所以加了这个。默认是关闭的。
* 单击白板空白处获得焦点后，按快捷键`Alt`​​​​+`D`​​​​即可开启/关闭该功能，左上角会有消息弹窗提示。
* 开启后，双击需要处理的文本元元素（此时会进入文本编辑状态），然后点击其他空白处取消文本的编辑状态即可。
* **平时建议关闭该功能，不然在粘贴代码文本的时候因为空格被清除了，字符会连到一起**。


## 四、其他可选的配置

### 1、手动更改画笔的粗细

打开挂件文件夹`Whiteboard`​​​​——`static`​​​​——`js`​​​​——`main.js`​​​​，这个main.js全名一般是：main.abb32a81.js 这种形式。在该js文件中搜索：

```css
simulatePressure:e.simulatePressure,size:1.2*e.strokeWidth
```

那个1.2是现在设置的值（已经相对小了），最开始的默认值是4点几，你可以根据自己需要更改这个值的大小来修改画笔的粗细。

### 2、设置固定端口（Windows端）

如果白板的`素材库`​​​​用的比较多的话，最好设置笔记的固定端口启动，因为添加进素材库的内容都是存到LocalStorage中的，设置后已添加到素材库的内容就不会在下一次启动后不显示了。

鼠标右键笔记桌面图标——`属性`​​​​——`快捷方式`​​​​——`目标(T)`​​​​，在`目标(T)`​​​​这栏的输入框中，是思源笔记可执行文件的路径，比如：

```css
D:\Siyuan\SiYuan.exe
```

在后面指定端口即可，比如：

```css
D:\Siyuan\SiYuan.exe  --port=6806
```


## 五、参考与感谢

* [Excalidraw项目](https://github.com/excalidraw/excalidraw)
* 画板中的中文字体文件拷贝自 [superdraw](https://github.com/zuoez02/superdraw) 项目；
* 感谢插件【开放 API】的作者[Zuoqiu-Yingyi](https://github.com/Zuoqiu-Yingyi)的贡献。

‍
