// å·¦ä¸Šè§’çš„æ¶ˆæ¯å¼¹çª—
let zh_CN = {
  "msgSaved": "å·²ä¿å­˜",
  "msgCopyFailed": "æ“ä½œå¤±è´¥ï¼Œæœªèƒ½å¤åˆ¶å…ƒç´ é“¾æŽ¥",
  "msgNotElement": "åˆšåˆšå¤åˆ¶çš„ä¸æ˜¯ç”»æ¿å…ƒç´ ï¼",
  "msgIDFailed": "æœªèƒ½èŽ·å–åˆ°ç”»æ¿å…ƒç´ çš„ID",
  "msgCopied": "å·²å°†é“¾æŽ¥å¤åˆ¶åˆ°å‰ªåˆ‡æ¿",
  "msgPreviewMode": "é¢„è§ˆæ¨¡å¼",
  "msgPreviewModeOff": "å·²å…³é—­é¢„è§ˆæ¨¡å¼",
  "msgAutoSaveOff": "å·²å…³é—­è‡ªåŠ¨ä¿å­˜ï¼",
  "msgAutoSaveOn": "ç¼–è¾‘ç»“æŸçº¦2såŽè‡ªåŠ¨ä¿å­˜",
  "msgNoRelevantResults": "æœªæŸ¥æ‰¾åˆ°ç›¸å…³ç»“æžœï¼",
  "msgNeedPlugin": "æ‚¬æµ®é¢„è§ˆå¤±è´¥ï¼Œå»ºè®®å…ˆå®‰è£…æ’ä»¶ã€å¼€æ”¾APIã€‘",
  "msgSaveFailed": "ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æŽ§åˆ¶å°æŠ¥é”™ä¿¡æ¯ï¼",
  "msgGetFileFailed": "ç”»æ¿æ–‡ä»¶èŽ·å–å¤±è´¥ï¼Œæ‰‹åŠ¨åˆ·æ–°åŽå°†æ–°å»ºç©ºçš„ç™½æ¿",
  "msgSetAliasFailed": "è®¾ç½®æ–‡æ¡£åˆ«åå¤±è´¥",
  "msgReadFilePathFailed": "æœªèƒ½è¯»å–åˆ°å—å±žæ€§ä¸­ç™½æ¿æ–‡ä»¶çš„è·¯å¾„ï¼Œå°†è‡ªåŠ¨åˆ·æ–°",
  "msgSetMemoFailed": "æ“ä½œå¤±è´¥ï¼æœªèƒ½å°†ç™½æ¿ä¸­çš„æ–‡æœ¬å­˜å…¥æ–‡æ¡£å¤‡æ³¨",
  "BtnSaveBlockRef": "ä¿å­˜å—å¼•ç”¨",
  "TipSaveBlockRef": "ä¿å­˜ç™½æ¿å¯¹å…¶ä»–æ–‡æ¡£/å—çš„å¼•ç”¨å…³ç³»",
  "BtnFixBrokenLinks": "ä¿®å¤å—è¶…é“¾æŽ¥",
  "TipFixBrokenLinks": "æ ¹æ®ç™½æ¿çš„å¯¹å…¶ä»–æ–‡æ¡£/å—çš„å¼•ç”¨å…³ç³»ï¼Œå°è¯•ä¿®å¤å¤±æ•ˆçš„å—è¶…é“¾æŽ¥",

  "msgNotEmbeddedBlock": "åµŒå…¥å—ä¸­ä¸æ”¯æŒè¯¥æ“ä½œ",
  "msgInsertList": "å·²æˆåŠŸåµŒå…¥å¼•ç”¨å—åˆ—è¡¨",
  "msgListUpdated": "å·²æ›´æ–°å¼•ç”¨å—åˆ—è¡¨",
  "msgNoLink": "å½“å‰ç™½æ¿æœªæ£€æµ‹åˆ°å—è¶…é“¾æŽ¥",
  "msgNoList": "æœªæ£€æµ‹åˆ°å¼•ç”¨å—åˆ—è¡¨",
  "msgFixLink": "å·²å°è¯•ä¿®å¤å¤±æ•ˆçš„å—è¶…é“¾æŽ¥",
  "msgFixLinkFailed": "æ“ä½œå¤±è´¥ï¼æœªèƒ½ä¿®å¤å¤±æ•ˆçš„å—è¶…é“¾æŽ¥"
}
let en_US = {
  "msgSaved": "Saved",
  "msgCopyFailed": "Operation failed, unable to copy the element link.",
  "msgNotElement": "The copied item is not a canvas element!",
  "msgIDFailed": "Failed to get the ID of the canvas element.",
  "msgCopied": "The link has been copied to the clipboard.",
  "msgPreviewMode": "Preview mode",
  "msgPreviewModeOff": "Preview mode has been turned off.",
  "msgAutoSaveOff": "Auto-save has been turned off!",
  "msgAutoSaveOn": "Automatically save about 2 seconds after editing ends.",
  "msgNoRelevantResults": "No relevant results found!",
  "msgNeedPlugin": "Hover preview failed, it is recommended to install the plugin [Open API] first.",
  "msgSaveFailed": "Save failed, please check the console for error messages!",
  "msgGetFileFailed": "Failed to get the canvas file, a new blank whiteboard will be created after manual refresh.",
  "msgSetAliasFailed": "Failed to set document alias.",
  "msgReadFilePathFailed": "Failed to read the path of the whiteboard file in the block attributes, will automatically refresh.",
  "msgSetMemoFailed": "Operation failed! The text in the whiteboard cannot be saved in the document notes.",
  "BtnSaveBlockRef": "SaveBlockRef",
  "TipSaveBlockRef": "Save the reference relationships of the whiteboard to other documents/blocks.",
  "BtnFixBrokenLinks": "FixBrokenLinks",
  "TipFixBrokenLinks": "According to the reference relationships of the whiteboard to other documents/blocks, try to repair the invalid block hyperlinks.",

  "msgNotEmbeddedBlock": "This operation is not supported in embedded blocks.",
  "msgInsertList": "The list of reference blocks has been successfully embedded.",
  "msgListUpdated": "The list of reference blocks has been updated.",
  "msgNoLink": "No block hyperlinks have been detected in the current whiteboard.",
  "msgNoList": "The list of reference blocks has not been detected.",
  "msgFixLink": "An attempt has been made to repair the invalid block hyperlinks.",
  "msgFixLinkFailed": "Operation failed! The invalid block hyperlinks could not be repaired."
}

// ç¬”è®°è½¯ä»¶è®¾ç½®è¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡ã€ç¹ä½“ä¸­æ–‡æ—¶ï¼Œå·¦ä¸Šè§’å¼¹å‡ºä¸­æ–‡æç¤ºï¼Œå¦è€…å¼¹å‡ºè‹±æ–‡æç¤º
window._languages = zh_CN;
let lang = window.top.siyuan.config.lang;
if (lang === "zh_CN" || lang === "zh_CHT") {
  window._languages = zh_CN;
} else {
  window._languages = en_US;
}


let myMessage = document.getElementById("myMessage");
let saveBtn = document.getElementById('saveBtn');
let refreshBtn = document.getElementById('refreshBtn');

// è¯·æ±‚å‡½æ•°
function request(url, data = null) { return new Promise((resolve, reject) => { fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data), }).then((data) => resolve(data.json()), (error) => { reject(error); }).catch((err) => { console.error("è¯·æ±‚å¤±è´¥:", err); }); }); };
// é˜²æŠ–
function debounce(e, t = 500) { let r = null; return function (...n) { clearTimeout(r), r = setTimeout((() => { e.apply(this, n) }), t) } }

// æ‰‹åŠ¨åˆ·æ–°
refreshBtn.addEventListener('click', () => { window.location.reload(); });
// æ‰‹åŠ¨ä¿å­˜
saveBtn.addEventListener('click', (e) => {
  if (window._isDarwin) {
    // macOSä¸Šçš„ä¿å­˜
    document.dispatchEvent(new KeyboardEvent("keydown", { key: "S", metaKey: true, bubbles: true }));
  } else {
    document.dispatchEvent(new KeyboardEvent("keydown", { key: "S", ctrlKey: true, bubbles: true }));
  }
}, false);


// å¼¹å‡ºæ¶ˆæ¯å¼¹çª—
window.showMessage = function (msg, duration = 2000) {
  let dom = document.createElement('div')
  dom.innerText = msg + ` (${new Date().toLocaleString()})`;
  dom.className = 'message'
  myMessage.appendChild(dom);
  setTimeout(() => {
    if (dom.previousElementSibling) {
      myMessage.removeChild(dom.previousElementSibling)
    }
  }, duration);
}


// åœ¨ç¬”è®°è½¯ä»¶V3.1.20ä¸­ï¼Œæ‚¬æµ®é¢„è§ˆAPIçš„å‚æ•°å·²ä¿®æ”¹ï¼Œéœ€è¦é€‚é…
function checkVersion() {
  window._isNewVersion = false;
  let version = window?.top?.siyuan?.config?.system?.kernelVersion;
  if (version) {
    try {
      let arr = version.split(".");
      arr[1] = arr[1].padStart(2, '0');
      arr[2] = arr[2].padStart(2, '0');
      version = parseInt(arr.join(""));
      if (version >= 30120) {
        window._isNewVersion = true;
      }
    } catch (err) {
      console.error(err)
    }
  }
}
checkVersion();

// é»˜è®¤å…³é—­æ‚¬æµ®é¢„è§ˆ
window._allowPreview = !1;
// å½“å‰ä½¿ç”¨çš„ä¸»é¢˜ï¼Œæ·±è‰²/æµ…è‰²
window._currentThemePath = localStorage?.getItem("excalidraw-theme") === "dark" ? "./theme/dark.css" : "./theme/theme.css";
// ä¿å­˜æ—¶é»˜è®¤å°†ç™½æ¿ä¸­çš„æ–‡æœ¬å†…å®¹å†™å…¥åˆ°æ–‡æ¡£â€”â€”å¤‡æ³¨ä¸­ï¼Œæ–¹ä¾¿å…¨å±€æ£€ç´¢
window._allowSetMemo = true;
// æ˜¯å¦é»˜è®¤å¼€å¯è‡ªåŠ¨ä¿å­˜
window._autoSave = true;
// è‡ªåŠ¨ä¿å­˜å»¶æ—¶æ—¶é—´ï¼Œå•ä½ï¼šms
window._autoSaveDelay = 2000;





// åˆå§‹æ¸²æŸ“æ—¶è§¦å‘çš„é‚£æ¬¡è‡ªåŠ¨ä¿å­˜æ²¡æœ‰å¿…è¦ï¼ŒåŽ»æŽ‰ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—
window._state = false;
if (window._autoSave) {
  window._state = true;
  window._autoSave = !window._autoSave;
}


// ä¿å­˜å—å¼•ç”¨
async function SaveBlockRef() {
  // åµŒå…¥å—ä¸­ä¸ç”Ÿæ•ˆ
  if (window?.frameElement?.parentElement?.parentElement?.parentElement?.classList?.contains("protyle-wysiwyg__embed")) {
    showMessage(window._languages["msgNotEmbeddedBlock"]);
    return
  }
  // èŽ·å–ç™½æ¿æ–‡ä»¶çš„è·¯å¾„
  let widgetID = window.frameElement.parentElement.parentElement.getAttribute('data-node-id');
  let memoPath = `assets/ExcalidrawFiles/${widgetID}.excalidraw`
  let memoData = await request("/api/attr/getBlockAttrs", { id: widgetID });
  if (memoData?.data["custom-data-assets"]) {
    memoPath = memoData.data["custom-data-assets"];
  }
  // èŽ·å–ç™½æ¿ä¸­çš„å—è¶…é“¾æŽ¥
  let res = await request("/api/file/getFile", { path: `/data/${memoPath}` })
  let r = res.elements;
  let str = "";
  if (r && r.length > 0) {
    r.forEach(item => {
      if (item.link && item.link.match(/siyuan\:\/\/blocks\/\d{14}-\w{7}/)) {
        let id = item.link.split("siyuan://blocks/")[1];
        str += `* ((${id} '${id}'))` + "\n"
      }
    })
  }
  // ç™½æ¿ä¸­æ²¡æœ‰å—è¶…é“¾æŽ¥æ—¶ï¼Œéœ€è¦æ¸…ç©ºå—å¼•ç”¨åˆ—è¡¨
  if (!str.trim()) {
    str = `* `;
  }
  // å°†å—è¶…é“¾æŽ¥ä¿å­˜åˆ°å½“å‰æ–‡æ¡£ï¼Œä»¥å¼•ç”¨å—çš„å½¢å¼
  let nextBlock = window.frameElement.parentElement.parentElement.nextSibling;
  if (!nextBlock || nextBlock?.getAttribute('data-subtype') !== "u") {
    let response = await request("/api/block/insertBlock", {
      "dataType": "markdown",
      "data": str,
      "previousID": widgetID,
    })
    if (response.code === 0) {
      showMessage(window._languages["msgInsertList"]);
    }
  } else {
    let targetBlockID = nextBlock.getAttribute("data-node-id");
    if (targetBlockID) {
      let res = await request("/api/block/updateBlock", {
        "dataType": "markdown",
        "data": str,
        "id": targetBlockID
      })
      if (res.code === 0) {
        showMessage(window._languages["msgListUpdated"]);
      }
    }
  }
}
window.addEventListener("SaveBlockRef", () => {
  SaveBlockRef().catch(err => { console.error(err) })
})


// ä¿®å¤å—è¶…é“¾æŽ¥
async function FixBrokenLinks() {
  // åµŒå…¥å—ä¸­ä¸ç”Ÿæ•ˆ
  if (window?.frameElement?.parentElement?.parentElement?.parentElement?.classList?.contains("protyle-wysiwyg__embed")) {
    showMessage(window._languages["msgNotEmbeddedBlock"]);
    return
  }
  let newIndex = {};
  let nextBlock = window?.frameElement?.parentElement?.parentElement?.nextSibling;
  let blockType = nextBlock?.getAttribute("data-subtype");
  if (!nextBlock || blockType !== "u") {
    showMessage(window._languages["msgNoList"])
  } else {
    let nextID = nextBlock?.getAttribute("data-node-id");
    let res = await request("/api/block/getChildBlocks", {
      id: nextID
    })
    if (res?.data?.length > 0) {
      res.data.forEach((item) => {
        const result = item.markdown.match(/\* \(\((\d{14}-\w{7}) \'(\d{14}-\w{7})\'\)\)/);
        if (result) {
          newIndex[result[2]] = result[1]
        }
      })
    }
    // å¯¼å…¥Siyuan .sy.zipæ—¶ï¼Œå—IDè¢«è½¯ä»¶é‡ç½®ï¼Œå¯¼è‡´å—è¶…é“¾æŽ¥å¤±æ•ˆã€‚éœ€è¦ä¿®æ­£å—è¶…é“¾æŽ¥
    let widgetID = window.frameElement.parentElement.parentElement.getAttribute('data-node-id');
    let memoPath = `assets/ExcalidrawFiles/${widgetID}.excalidraw`
    let memoData = await request("/api/attr/getBlockAttrs", { id: widgetID });
    if (memoData?.data["custom-data-assets"]) {
      memoPath = memoData.data["custom-data-assets"];
    }
    // èŽ·å–ç™½æ¿ä¸­çš„å—è¶…é“¾æŽ¥
    let res2 = await request("/api/file/getFile", { path: `/data/${memoPath}` })
    let r = res2.elements;
    if (r && r.length > 0) {
      r.forEach(item => {
        if (item.link && item.link.match(/siyuan\:\/\/blocks\/\d{14}-\w{7}/)) {
          let id = item.link.split("siyuan://blocks/")[1];
          if (newIndex[id]) {
            item.link = "siyuan://blocks/" + newIndex[id]
          }
        }
      })
      res2.elements = r;

      let DataBlob = new Blob([JSON.stringify(res2)], {
        type: "application/json",
      });
      let tempArr = memoPath.split("/");
      let fileName = tempArr[tempArr.length - 1];
      let DataFile = new File([DataBlob], fileName);
      let reqBody = new FormData();
      reqBody.append("path", `/data/${memoPath}`);
      reqBody.append("file", DataFile);
      fetch("/api/file/putFile", {
        body: reqBody,
        method: "POST",
        headers: {},
      })
        .then(function () {
          if (window?.top?.openAPI?.siyuan?.showMessage) {
            window.top.openAPI.siyuan.showMessage(window._languages["msgFixLink"]);
          }
          window.location.reload();
        })
        .catch((err) => {
          showMessage(window._languages["msgFixLinkFailed"]);
          console.error(err);
        });
    } else {
      showMessage(window._languages["msgNoLink"])
    }
  }
}

window.addEventListener("FixBrokenLinks", () => {
  FixBrokenLinks().catch(err => { console.error(err) })
})





// æ£€ç´¢é¢æ¿
const searchBlocksPanel = document.getElementById('searchBlocksPanel');
const deleteBtn = document.getElementById('delete');
const keywordBtn = document.getElementById('keyword');
const resultList = document.getElementById('result');
const closeBtn = document.getElementById('close')


// å…³é—­æŒ‰é’®
closeBtn.addEventListener("click", () => {
  searchBlocksPanel.style.visibility = "hidden";
})


// æ¸…ç©ºè¾“å…¥æ¡†
deleteBtn.addEventListener('click', () => {
  keywordBtn.value = "";
  resultList.innerHTML = "";
  keywordBtn.focus();
})

let itemsArr = [], currentIndex = 0;
// æ£€ç´¢æ–‡æ¡£ã€æ ‡é¢˜
async function handleInput() {
  resultList.innerHTML = "";
  if (keywordBtn.value.trim()) {
    let keyword = keywordBtn.value;
    let res = await request("/api/search/searchRefBlock", {
      "k": keyword,
      "id": "10000000000000-buciyqd",
      "beforeLen": 24,
      "rootID": "10000000000000-buciyqd",
      "isDatabase": false,
      "isSquareBrackets": true,
      "reqId": Date.now()
    })
    if (res.code === 0 && res?.data?.blocks?.length > 0) {
      let docList = res.data.blocks;
      let f = document.createDocumentFragment();
      docList.forEach(item => {
        let name = "";
        let alias = "";
        let memo = "";
        let icon = ""
        if (item.name) {
          name = `<span class="alias"><svg class="icon"><use xlink:href="#iconN"></use></svg>${item.name}</span>`
        }
        if (item.alias) {
          alias = `<span class="alias"><svg class="icon"><use xlink:href="#iconA"></use></svg>${item.alias}</span>`
        }
        if (item.memo) {
          memo = `<span class="memo"><svg class="icon"><use xlink:href="#iconM"></use></svg>${item.memo}</span>`
        }
        if (item.type === "NodeHeading") {
          switch (item.subType) {
            case "h1":
              icon = `<svg class="icon"><use xlink:href="#iconHeadings"></use></svg>`
              break;
            case "h2":
              icon = `<svg class="icon"><use xlink:href="#iconH2"></use></svg>`
              break;
            case "h3":
              icon = `<svg class="icon"><use xlink:href="#iconH3"></use></svg>`
              break;
            case "h4":
              icon = `<svg class="icon"><use xlink:href="#iconH4"></use></svg>`
              break;
            case "h5":
              icon = `<svg class="icon"><use xlink:href="#iconH5"></use></svg>`
              break;
            case "h6":
              icon = `<svg class="icon"><use xlink:href="#iconH6"></use></svg>`
              break;
            default:
              icon = `<svg class="icon"><use xlink:href="#iconHeadings"></use></svg>`
          }
        } else {
          switch (item.type) {
            case "NodeDocument":
              icon = `ðŸ“„`
              break;
            case "NodeParagraph":
              icon = `<svg class="icon"><use xlink:href="#iconParagraph"></use></svg>`
              break;
            case "NodeMathBlock":
              icon = `<svg class="icon"><use xlink:href="#iconMath"></use></svg>`
              break;
            case "NodeTable":
              icon = `<svg class="icon"><use xlink:href="#iconTable"></use></svg>`
              break;
            case "NodeCodeBlock":
              icon = `<svg class="icon"><use xlink:href="#iconCode"></use></svg>`
              break;
            case "NodeHTMLBlock":
              icon = `<svg class="icon"><use xlink:href="#iconHTML5"></use></svg>`
              break;
            case "NodeAttributeView":
              icon = `<svg class="icon"><use xlink:href="#iconDatabase"></use></svg>`
              break;
            case "NodeBlockQueryEmbed":
              icon = `<svg class="icon"><use xlink:href="#iconSQL"></use></svg>`
              break;
            case "NodeVideo":
              icon = `<svg class="icon"><use xlink:href="#iconVideo"></use></svg>`
              break;
            case "NodeAudio":
              icon = `<svg class="icon"><use xlink:href="#iconRecord"></use></svg>`
              break;
            case "NodeIFrame":
              icon = `<svg class="icon"><use xlink:href="#iconLanguage"></use></svg>`
              break;
            case "NodeWidget":
              icon = `<svg class="icon"><use xlink:href="#iconBoth"></use></svg>`
              break;
            case "NodeBlockquote":
              icon = `<svg class="icon"><use xlink:href="#iconQuote"></use></svg>`
              break;
            case "NodeSuperBlock":
              icon = `<svg class="icon"><use xlink:href="#iconSuper"></use></svg>`
              break;
            case "NodeList":
              icon = `<svg class="icon"><use xlink:href="#iconList"></use></svg>`
              break;
            case "NodeListItem":
              icon = `<svg class="icon"><use xlink:href="#iconListItem"></use></svg>`
              break;
          }
        }
        let dom = document.createElement('div');
        dom.className = "searchItem";
        dom.innerHTML = `${name}${alias}${memo}<div class="path">${item.hPath}</div>
                <div class="title"><span class="link" data-href="siyuan://blocks/${item.id}" >${icon}</span> ${item.content}</div> <div class="insertDoc" data-href="siyuan://blocks/${item.id}" >âž•</div>`;
        f.append(dom);

      });
      resultList.append(f);
      // æ›´æ–°æœç´¢ç»“æžœ
      itemsArr = resultList.querySelectorAll("div.searchItem");
      currentIndex = 0;
      itemsArr[currentIndex].classList.add("active");
    } else {
      resultList.innerHTML = "æœªæŸ¥è¯¢åˆ°ç›¸å…³ç»“æžœ";
    }
  }

}

keywordBtn.addEventListener('input', debounce(handleInput));

// æ–‡æ¡£åã€æ ‡é¢˜åå‰çš„å›¾æ ‡ï¼Œç‚¹å‡»è·³è½¬åˆ°å¯¹åº”çš„å—
resultList.addEventListener("click", (e) => {
  if (e.target.tagName === "SPAN" && e.target.className === "link") {
    e.stopPropagation();
    let url = e.target.getAttribute("data-href");
    window.top.openFileByURL(url);
  } else if (e.target.tagName === "svg") {
    e.stopPropagation();
    let url = e.target.parentElement.getAttribute("data-href");
    window.top.openFileByURL(url);

  } else if (e.target.tagName === "use") {
    e.stopPropagation();
    let url = e.target.parentElement.parentElement.getAttribute("data-href");
    window.top.openFileByURL(url);
  } else if (e.target.tagName === "DIV" && e.target.className === "insertDoc") {
    e.stopPropagation();
    let url = e.target.getAttribute("data-href");
    window.dispatchEvent(new CustomEvent("createEmbedElement", { detail: { link: url } }));
  }
}, false)




// ä¸Šã€ä¸‹ç®­å¤´åˆ‡æ¢æœç´¢ç»“æžœ
keywordBtn.addEventListener("keydown", (e => {
  if ("ArrowDown" === e.key) {
    itemsArr[currentIndex].classList.remove("active");
    if (currentIndex + 1 < itemsArr.length) {
      currentIndex += 1;
      itemsArr[currentIndex].classList.add('active');
    } else {
      currentIndex = 0;
      itemsArr[currentIndex].classList.add('active');
    }
    let offsetTop = itemsArr[currentIndex].offsetTop;
    let gap = resultList.offsetHeight - 100;
    resultList.scrollTo(0, offsetTop < gap ? 0 : offsetTop - gap);
  }

  if ("ArrowUp" === e.key) {
    e.stopPropagation();
    e.preventDefault();
    itemsArr[currentIndex].classList.remove("active");
    if (currentIndex > 0) {
      currentIndex -= 1;
      itemsArr[currentIndex].classList.add('active');
    } else {
      currentIndex = itemsArr.length - 1;
      itemsArr[currentIndex].classList.add('active');
    }
    let offsetTop = itemsArr[currentIndex].offsetTop;
    let gap = resultList.offsetHeight - 100;
    resultList.scrollTo(0, offsetTop < gap ? 0 : offsetTop - gap);

  }
  //  æŒ‰EnteråµŒå…¥å½“å‰å·²é€‰ä¸­çš„æ–‡æ¡£å—æˆ–æ ‡é¢˜å—
  if ("Enter" === e.key) {
    let selectedResult = resultList.querySelector("div.searchItem.active");
    if (selectedResult) {
      let url = selectedResult.querySelector("span.link")?.getAttribute("data-href");
      if (url) { window.dispatchEvent(new CustomEvent("createEmbedElement", { detail: { link: url } })); }
    }

  }
}), false);

// ã€Mermaidè‡³å›¾è¡¨ã€‘ç•Œé¢çš„è¶…é“¾æŽ¥
document.addEventListener("click", (e) => {
  if (e.target.tagName === "A") {
    e.preventDefault();
    e.stopPropagation();
    try {
      let url = e.target.getAttribute("href");
      window.top.open(url);
    } catch (err) { console.error(err) }
  }
}, false)

// å¿«æ·é”®
document.addEventListener("keydown", (e => {
  // å¼€å¯é¢„è§ˆ
  if (e.altKey && "q" === e.key) {
    window._allowPreview = !0;
    showMessage(window._languages["msgPreviewMode"])
  }
  // å…³é—­é¢„è§ˆ
  if (e.altKey && "w" === e.key) {
    window._allowPreview = !1;
    showMessage(window._languages["msgPreviewModeOff"]);
  }
  // ä¸´æ—¶å¼€å¯/å…³é—­ã€è‡ªåŠ¨ä¿å­˜ã€‘
  if (e.altKey && "f" === e.key) {
    window._autoSave = !window._autoSave;
    if (!window._autoSave) {
      showMessage(window._languages["msgAutoSaveOff"])
    } else {
      showMessage(window._languages["msgAutoSaveOn"])
    }
  }
  // å¿«æ·é”®â€”â€”æ˜¾ç¤º/éšè—æ£€ç´¢é¢æ¿
  if (e.altKey && "p" === e.key) {
    if (searchBlocksPanel.style.visibility === "hidden") {
      searchBlocksPanel.style.visibility = "visible";
      keywordBtn.focus();
    } else {
      searchBlocksPanel.style.visibility = "hidden";
    }
  }
  // å¿«æ·é”®â€”â€”æ˜¾ç¤º/éšè—iframeä¸­æœç´¢ã€é«˜äº®æ–‡æœ¬çš„é¢æ¿
  if (e.altKey && "o" === e.key) {
    if (searchIframeTextPanel.style.visibility === "hidden") {
      searchIframeTextPanel.style.visibility = "visible";
      keywordInput.focus();
    } else {
      closeSearch();
    }
  }
  // å…¨å±
  if (e.altKey && "y" === e.key) {
    if (window?.frameElement?.parentElement?.parentElement?.parentElement?.parentElement?.parentElement?.classList?.contains("protyle")) {
      if (window?.frameElement?.parentElement?.parentElement?.parentElement?.parentElement?.parentElement?.classList?.contains("fullscreen")) {
        window.frameElement.parentElement.parentElement.parentElement.parentElement.parentElement.classList.remove("fullscreen");
      } else {
        window.frameElement.parentElement.parentElement.parentElement.parentElement.parentElement.classList.add("fullscreen");
      }
    }
  }
}), !0);


// æ£€ç´¢é¢æ¿ä½¿ç”¨æ·±è‰²ä¸»é¢˜
function setColor() {
  if (localStorage?.getItem("excalidraw-theme") === "dark") {
    try {
      let pannel = document.getElementById("searchBlocksPanel");
      pannel.classList.add("dark");
    } catch (err) {
      console.error(err);
    }
  }
}
setColor();




// æœç´¢ã€é«˜äº®iframeä¸­çš„å…³é”®è¯
const searchIframeTextPanel = document.getElementById("searchIframeText")
const keywordInput = document.getElementById('keywordInIframe');
const previousItemBtn = document.getElementById('previousItem');
const nextItemBtn = document.getElementById("nextItem");
const closeSearchBtn = document.getElementById("closeSearch")
const sum = document.getElementById('sum');
const currentIframeIndex = document.getElementById('currentIframeIndex')
let currentPageNum = 0;
window._searchList = [];


function searchIframeText() {
  currentPageNum = 0;
  // æœç´¢ç»“æžœçš„æ•°é‡é‡ç½®
  currentIframeIndex.innerText = 0;
  sum.innerText = 0;
  window._searchList = [];
  let articles = document.querySelectorAll("iframe");
  if (articles.length > 0) {
    articles.forEach(article => {
      try { article.contentWindow._searchText(keywordInput.value); } catch (err) { }
    });
    sum.innerText = window._searchList.length;
    if (window._searchList.length > 0) {
      // æœç´¢åŽè‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœç´¢ç»“æžœ
      window._scrollToContent(window._searchList[currentPageNum], { animate: true });
      currentPageNum = 0;
      currentIframeIndex.innerText = currentPageNum + 1;
    }
  }
}
function closeSearch() {
  keywordInput.value = "";
  window._searchList = [];
  currentIframeIndex.innerText = 0;
  sum.innerText = 0;
  let articles = document.querySelectorAll("iframe");
  if (articles.length > 0) {
    articles.forEach(article => {
      // å–æ¶ˆiframeä¸­çš„é«˜äº®
      try { article.contentWindow._cancelHighligh(); } catch (err) { }
    });
  }
  searchIframeTextPanel.style.visibility = "hidden";

}
function toNextItem() {
  if (window._searchList.length > 0) {
    if (currentPageNum < window._searchList.length - 1) {
      currentPageNum = currentPageNum + 1;
      currentIframeIndex.innerText = currentPageNum + 1;
      window._scrollToContent(window._searchList[currentPageNum], { animate: true });
    } else {
      currentPageNum = 0;
      currentIframeIndex.innerText = currentPageNum + 1;
      window._scrollToContent(window._searchList[currentPageNum], { animate: true });
    }
  }
}
function toPreviousItem() {
  if (window._searchList.length > 0) {
    if (currentPageNum > 0) {
      currentPageNum = currentPageNum - 1;
      currentIframeIndex.innerText = currentPageNum + 1;
      window._scrollToContent(window._searchList[currentPageNum], { animate: true });
    } else {
      currentPageNum = window._searchList.length - 1;
      currentIframeIndex.innerText = currentPageNum + 1;
      window._scrollToContent(window._searchList[currentPageNum], { animate: true });
    }
  }
}
// æ£€ç´¢å…³é”®å­—
keywordInput.addEventListener("input", debounce(searchIframeText))
// å…³é—­æ£€ç´¢æ¡†
closeSearchBtn.addEventListener("click", closeSearch)
//æŒ‰é’®â€”â€”åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœç´¢ç»“æžœ
nextItemBtn.addEventListener("click", toNextItem)
// æŒ‰é’®â€”â€”åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæœç´¢ç»“æžœ
previousItemBtn.addEventListener("click", toPreviousItem)
// è¾“å…¥æ¡†ä¸­æŒ‰Enter
keywordInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    e.stopPropagation();
    toNextItem();
  }
})


