<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Excalidraw | Hand-drawn look & feel • Collaborative • Secure</title>
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
    <meta name="theme-color" content="#121212" />
    <meta name="title" content="Excalidraw" />
    <style>html.dark {background-color: #121212;color: #fff;}</style>
    <!-- 挂件自动全屏，铺满当前页签，PC端设置z-index:2,移动端设置z-index:1 -->
    <script>
      try {
        //调试—— 检查当前的设备，如果是MacOS，处理保存时按键不一样的问题
        const isDarwin = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
        window._isDarwin = isDarwin;
        const isMobile = navigator.userAgent.match(/android|iphone|ipad|ipod/i);
        let isNodeBlockQueryEmbed = window?.frameElement?.parentElement?.parentElement?.parentElement?.classList?.contains("protyle-wysiwyg__embed");
        window.isNodeBlockQueryEmbed = isNodeBlockQueryEmbed;
        if (isMobile) {
          if (isNodeBlockQueryEmbed) {
            window.frameElement.setAttribute("style", "width:98%;height:600px;z-index:1;"), window.frameElement.parentElement.setAttribute("style", "width:100%;height:100%;"), window.frameElement.parentElement.parentElement.setAttribute("style", "width:100%;height:100%;margin:0px;padding:0px;");
          } else {
            window.frameElement.setAttribute("style", "position:absolute;left:0px;top:0px;width:100%;height:100%;z-index:1;"), window.frameElement.parentElement.setAttribute("style", "width:100%;height:100%;"), window.frameElement.parentElement.parentElement.setAttribute("style", "position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;margin:0px;padding:0px;")
          }
        }
        else {
          if (isNodeBlockQueryEmbed) {
            window.frameElement.setAttribute("style", "width:98%;height:600px;z-index:2;"), window.frameElement.parentElement.setAttribute("style", "width:100%;height:100%;"), window.frameElement.parentElement.parentElement.setAttribute("style", "width:100%;height:100%;margin:0px;padding:0px;");
          } else {
            window.frameElement.setAttribute("style", "position:absolute;left:0px;top:0px;width:100%;height:100%;z-index:2;"), window.frameElement.parentElement.setAttribute("style", "width:100%;height:100%;"), window.frameElement.parentElement.parentElement.setAttribute("style", "position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;margin:0px;padding:0px;")
          }
        }
      } catch (t) {console.error(t)}</script>
    <meta name="version" content="2024-02-20T21:43:54.028Z-none" />
    <link rel="preload" href="./Virgil.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="preload" href="./Cascadia.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="stylesheet" href="./fonts.css" type="text/css" />
    <style>
      body,
      html {
        margin: 0;
        -webkit-text-size-adjust: 100%;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
        user-select: none;
      }
      #root {
        height: 100%;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      @media screen and (min-width: 1200px) {
        #root {
          -webkit-touch-callout: default;
          -webkit-user-select: auto;
          -khtml-user-select: auto;
          -moz-user-select: auto;
          -ms-user-select: auto;
          user-select: auto;
        }
      }
      /* Mermaid to Excalidraw */
      button.dropdown-menu-button.App-toolbar__extra-tools-trigger.zen-mode-transition+.dropdown-menu.App-toolbar__extra-tools-dropdown button:last-child {
        display: none !important;
      }
      /* 右键菜单的粘贴按钮失效，暂时不想花时间去修复了 */
      .excalidraw .popover>ul.context-menu>li[data-testid="paste"],
      .excalidraw .popover>ul.context-menu>li[data-testid="paste"]+hr.context-menu-item-separator {
        display: none;
      }
      /* 在线素材库 */
      .layer-ui__library .library-menu-items__no-items,
      .layer-ui__library a.library-menu-browse-button,
      .layer-ui__library .library-menu-items-container__header.library-menu-items-container__header--excal,
      .layer-ui__library div[style="margin: 1rem 0px; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; font-size: 0.9rem;"] {
        display: none !important;
      }
      /* 隐藏——右下角——帮助按钮 */
      div[style="display: flex; gap: 0.5rem; align-items: center;"] {
        display: none !important;
      }
      button.help-icon {
        display: none !important;
      }
      /* 隐藏——左上角菜单中的链接 */
      .Island.dropdown-menu-container>a {
        display: none !important;
      }
      /* 样式——保存按钮 */
      #saveBtn {
        position: fixed;
        width: 30px;
        height: 36px;
        top: 34px;
        left: 84px;
        padding: 0 7px;
        transform: translate(-50%, -50%);
        z-index: 3;
        text-align: center;
        line-height: 36px;
        font-size: 12px;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        background-color: transparent;
      }
      #refreshBtn {
        position: fixed;
        width: 28px;
        height: 36px;
        top: 34px;
        right: 84px;
        padding: 0 7px;
        transform: translate(-50%, -50%);
        z-index: 3;
        text-align: center;
        line-height: 36px;
        font-size: 12px;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        background-color: transparent;
      }
      html:not(.dark) #saveBtn,
      html:not(.dark) #refreshBtn{
        border: 1px solid #2323291c;
      }
      html:not(.dark) #saveBtn:hover,
      html:not(.dark) #refreshBtn:hover {
        background-color: #F1F0FF
      }
      html.dark #saveBtn,
      html.dark #refreshBtn {
        color: #E3E3E8;
        border: 1px solid #363541;
      }
      html.dark #saveBtn:hover,
      html.dark #refreshBtn:hover {
        background-color: #363541;
      }
      .message {
        height: auto;
        max-width: 400px;
        padding: 0px 10px 0px 10px;
        background-color: transparent;
        color: #B8B8B8;
        margin-bottom: 5px;
        border-radius: 5px;
        user-select: none;
      }
      #myMessage {
        width: 277px;
        max-height: 400px;
        padding: 0px 15px;
        position: fixed;
        text-align: left;
        line-height: 25px;
        top: 17px;
        left: 96px;
        font-size: 12px;
        border-radius: 7px;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: start;
      }
        
      @media screen and (max-width:1217px){#myMessage{top: 60px;left: -2px;}}
      @media screen and (max-width:853px){#saveBtn{top: 81px;left: 31px;}#refreshBtn{top: 81px;right: 17px;}#myMessage{top: 101px;left: -2px;}}


      /* 搜索面板 */
      .ExcalidrawItem:hover {
        background-color: #8ad4df !important
      }
      .ExcalidrawItem.active {
        background-color: #8ad4df !important
      }
    </style>
    <script type="module" crossorigin src="./assets/index-c894b550.js"></script>
    <link rel="stylesheet" href="./assets/index-8a263e3d.css">
    <link rel="manifest" href="./manifest.webmanifest"></head>
  <body>
    <noscript> You need to enable JavaScript to run this app. </noscript>
    <header>
      <h1 class="visually-hidden">Excalidraw</h1>
    </header>
    <div id="root"></div>
    <!-- 消息弹窗 -->
    <div id="myMessage"></div>
    <!-- 左上角——保存按键 -->
    <div id="saveBtn">
      保存
    </div>
    <div id="refreshBtn">
      刷新
    </div>
    <!-- 搜索面板 -->
    <div id="searchPanel"
      style="position:fixed;z-index:1000;top:62px;left:6px;width:24vw;min-width:300px;height:74vh;background:#f8f9fa;box-shadow:0 0 6px 0 #0000008c;visibility:hidden;overflow:auto;padding:0 27px">
      <div
        style="position:sticky;top:0;padding-top:10px;margin-bottom:20px;background-color:#f8f9fa;z-index:1;display:flex"
        class="topBar"><input id="keywordInput" placeholder="检索关键字"
          style="outline:0;color:#000;background:#fff;border:1px solid gray;border-radius:4px;flex:1" size="20"></div>
      <div id="targetArrContainer" class="targetArrContainer"></div>
    </div>
    <script>
      ; let myMessage = document.getElementById("myMessage");
      let saveBtn = document.getElementById('saveBtn');
      let refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.addEventListener('click', () => { window.location.reload(); })
     // 弹出消息弹窗
     window.showMessage = function (msg, duration = 2000) {
        let dom = document.createElement('div')
        dom.innerText = msg+`（${new Date().toLocaleString()}）`;
        dom.className = 'message'
        myMessage.appendChild(dom);
        setTimeout(() => {
          if(dom.previousElementSibling){
            myMessage.removeChild(dom.previousElementSibling)
          }
        }, duration);
      }
      // 保存时默认将白板中的文本内容写入到文档——备注中，方便全局检索
      window._allowSetMemo = true;
      // 默认关闭悬浮预览
      window._allowPreview = !1;
      // 是否默认开启自动保存
      window._autoSave = true;
      // 调试——初始渲染时触发的那次自动保存没有必要，去掉，减少性能消耗
      window._state = false;
      if (window._autoSave) {
        window._state = true;
        window._autoSave = !window._autoSave;
      }
      // 复制内容到剪切板
      function patseIntoClipboard(txt) {
        let status = false
        const input = document.createElement('textarea')
        document.body.appendChild(input)
        input.innerHTML = txt
        input.select()
        if (document.execCommand('copy')) {
          document.execCommand('copy')
          status = true
        } else {
          showMessage('复制失败')
        }
        document.body.removeChild(input)
        return status
      }
      async function getElementIDFromClipboadr() {
        let str = await navigator.clipboard.readText()
        if (!str.startsWith(`{"type":"excalidraw/clipboard"`)) {
          showMessage('刚刚复制的不是画板元素！')
          return null
        }
        let result = str.match(/\"id\"\:\"(.+?)\"/);
        let id;
        if (result && result[1]) {
          id = result[1]
        } else {
          showMessage("ID匹配失败")
          return null
        }
        let status = patseIntoClipboard(`excalidraw://${id}`);
        showMessage('已将链接复制到剪切板')
      }
      // 快捷键
      document.addEventListener("keydown", (e => {
        if (e.altKey && "q" === e.key) {
          window._allowPreview = !0;
          showMessage("预览模式")
        }
        if (e.altKey && "w" === e.key) {
          window._allowPreview = !1;
          showMessage("关闭预览");
        }
        if (e.altKey && "f" === e.key) {
          window._autoSave = !window._autoSave;
          if (!window._autoSave) {
            showMessage('已关闭自动保存！')
          } else {
            showMessage('编辑结束约2s后自动保存')
          }
        }
        if (e.ctrlKey && e.key === "j") {
          getElementIDFromClipboadr();
        }
        // 全屏
        if(e.altKey && "y" === e.key){
          if(window?.frameElement?.parentElement?.parentElement?.parentElement?.parentElement?.parentElement?.classList?.contains("protyle")){
            if( window?.frameElement?.parentElement?.parentElement?.parentElement?.parentElement?.parentElement?.classList?.contains("fullscreen")){
              window.frameElement.parentElement.parentElement.parentElement.parentElement.parentElement.classList.remove("fullscreen");
            }else{
              window.frameElement.parentElement.parentElement.parentElement.parentElement.parentElement.classList.add("fullscreen");
            }
          }
        }
      }), !0);
      // 调试——手动保存
      saveBtn.addEventListener('click', (e) => {
        if (window._isDarwin) {
          // macOS上的保存
          document.dispatchEvent(new KeyboardEvent("keydown", { key: "S", metaKey: true, bubbles: true }));
        } else {
          document.dispatchEvent(new KeyboardEvent("keydown", { key: "S", ctrlKey: true, bubbles: true }));
        }
      }, false);
      // 调试——搜素关键字
      (async () => {
        function request(url, data = null) {return new Promise((resolve, reject) => {fetch(url, {method: "POST",headers: { "Content-Type": "application/json" },body: JSON.stringify(data),}).then((data) => resolve(data.json()),(error) => {reject(error);}).catch((err) => {console.error("请求失败:", err);});});}
        ; const searchPanel = document.getElementById("searchPanel"),
          keywordInput = document.getElementById("keywordInput"),
          targetArrContainer = document.getElementById("targetArrContainer");
        async function itemsContainsKeyword(e) {
          let t = []; e = e.trim();
          let widgetID = window.frameElement.parentElement.parentElement.getAttribute('data-node-id');
          let memoPath = `assets/ExcalidrawFiles/${widgetID}.excalidraw`
          let memoData = await request("/api/attr/getBlockAttrs", { id: widgetID });
          if (memoData?.data["custom-data-assets"]) {
            memoPath = memoData.data["custom-data-assets"];
          }
          let res = await request("/api/file/getFile", { path: `/data/${memoPath}` })
          let r = res.elements;
          if (r && e.length > 0) {
            let keywordArr = e.split(' ');
            keywordArr = keywordArr.filter((item) => item.trim());
            keywordArr = Array.from(new Set(keywordArr));
            for (let n of r) if ("text" === n.type && keywordArr.every((item) => new RegExp(`${item}`, "i").test(n.text))) {
              n.text = n.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
              keywordArr.forEach((item) => {
                let r = new RegExp(`${item}`, "ig");
                n.text = n.text.replace(r, (function (e) { return ` ${e} ` }));
              });
              keywordArr.forEach((item) => {
                let r = new RegExp(` ${item} `, "ig");
                n.text = n.text.replace(r, (function (e) { return `<span style="background-color:#ffe955;color:black;">${e.trim()}</span>` }));
              });
              t.push([n.text, n.id, n.x, n.y]);
            }
          }
          return t
        }
        function debounce(e, t = 500) { let r = null; return function (...n) { clearTimeout(r), r = setTimeout((() => { e.apply(this, n) }), t) } }
        let itemsArr = [], currentIndex = -1;
        async function handleKeywordSubmit() {
          const e = keywordInput.value.trim();
          if (itemsArr = [], e.length > 0) if (targetArrContainer.innerHTML = "", itemsArr = await itemsContainsKeyword(e), itemsArr.length > 0) {
            const e = document.createDocumentFragment(); itemsArr.forEach((t => { const r = document.createElement("div"); r.className = "ExcalidrawItem", r.style.marginTop = "6px", r.style.color = "black", r.style.backgroundColor = "#ffffff", r.style.borderRadius = "4px", r.style.padding = "3px", r.setAttribute("data-x", t[2]), r.setAttribute("data-y", t[3]), r.innerHTML = `${t[0]}`, e.appendChild(r) })), targetArrContainer.appendChild(e)
          } else targetArrContainer.innerHTML = "未查找到相关结果！", currentIndex = -1; else targetArrContainer.innerHTML = "未查找到相关结果！", currentIndex = -1
        }
        keywordInput.addEventListener("input", debounce(handleKeywordSubmit), !1),
          targetArrContainer.addEventListener("click", (e => {
            e.stopPropagation(); let t = targetArrContainer.querySelectorAll("div.ExcalidrawItem");
            if (e.target.classList.contains("ExcalidrawItem")) { const r = parseInt(e.target.getAttribute("data-x")), n = parseInt(e.target.getAttribute("data-y")); window.dispatchEvent(new CustomEvent("searchKeyword", { detail: { x: r, y: n } })); for (let r = 0; r < t.length; r++)e.target !== t[r] || t[r].classList.contains("active") ? t[r].classList.remove("active") : (t[r].classList.add("active"), currentIndex = r) }
            else if ("SPAN" === e.target.tagName && e.target.parentElement.classList.contains("ExcalidrawItem")) {
              const r = parseInt(e.target.parentElement.getAttribute("data-x")), n = parseInt(e.target.parentElement.getAttribute("data-y"));
              window.dispatchEvent(new CustomEvent("searchKeyword", { detail: { x: r, y: n } }));
              for (let r = 0; r < t.length; r++)e.target.parentElement !== t[r] || t[r].classList.contains("active") ? t[r].classList.remove("active") : t[r].classList.add("active")
            }
          }), !1),
          searchPanel.addEventListener("click", (e => { e.stopPropagation() }), !1), document.addEventListener("keydown", (e => { e.altKey && "t" === e.key && (searchPanel.style.visibility = "hidden" === searchPanel.style.visibility ? "visible" : "hidden", keywordInput.focus(), currentIndex = -1) }), !1), document.addEventListener("click", (e => { "visible" === searchPanel.style.visibility && (searchPanel.style.visibility = "hidden") }), !1), keywordInput.addEventListener("keydown", (e => { if (itemsArr.length > 0 && ("ArrowDown" === e.key || "ArrowUp" === e.key)) { "ArrowDown" === e.key ? currentIndex++ : "ArrowUp" === e.key && (e.preventDefault(), currentIndex--), currentIndex > itemsArr.length - 1 && (currentIndex = 0), currentIndex < 0 && (currentIndex = itemsArr.length - 1); let t = targetArrContainer.querySelectorAll("div.ExcalidrawItem"); for (let e = 0; e < t.length; e++)e !== currentIndex || t[e].classList.contains("active") ? t[e].classList.remove("active") : t[e].classList.add("active"); const r = parseInt(itemsArr[currentIndex][2]), n = parseInt(itemsArr[currentIndex][3]); window.dispatchEvent(new CustomEvent("searchKeyword", { detail: { x: r, y: n } })) } }), !1);
      })()
    </script>
  </body>
</html>